#!/usr/bin/env Rscript
suppressPackageStartupMessages({
  library(Seurat)
  library(dplyr)
  library(ggplot2)
  library(openxlsx)
})

args <- commandArgs(trailingOnly = TRUE)
get_arg <- function(flag, default = NULL) {
  hit <- which(args == flag)
  if (length(hit) == 0) return(default)
  if (hit == length(args)) stop(paste("Missing value for", flag))
  args[hit + 1]
}

out_dir    <- get_arg("--out_dir", default = "./output")
resolution <- as.numeric(get_arg("--resolution", default = "0.7"))

rds_in <- file.path(out_dir, paste0("GSE212966_integrated_annotated_res", resolution, ".rds"))
if (!file.exists(rds_in)) stop("Cannot find: ", rds_in)

seurat_integrated <- readRDS(rds_in)
DefaultAssay(seurat_integrated) <- "RNA"

# Subset fibroblasts
seurat_fib <- subset(seurat_integrated, idents = "Fibroblasts")
saveRDS(seurat_fib, file.path(out_dir, "Fibro_subset_raw.rds"))

# Re-cluster fibro subset
DefaultAssay(seurat_fib) <- "RNA"
suppressWarnings({
  try(seurat_fib <- JoinLayers(seurat_fib, layers = c("RNA", "integrated")), silent = TRUE)
})

seurat_fib <- NormalizeData(seurat_fib)
seurat_fib <- FindVariableFeatures(seurat_fib, selection.method = "vst", nfeatures = 2000)
seurat_fib <- ScaleData(seurat_fib)
seurat_fib <- RunPCA(seurat_fib, features = VariableFeatures(seurat_fib))
seurat_fib <- RunUMAP(seurat_fib, dims = 1:10)
seurat_fib <- FindNeighbors(seurat_fib, dims = 1:10)
seurat_fib <- FindClusters(seurat_fib, resolution = 0.2)

ggsave(
  filename = file.path(out_dir, "Fibro_UMAP_clusters_res0.2.pdf"),
  plot = DimPlot(seurat_fib, reduction = "umap", label = TRUE) + NoLegend(),
  width = 8, height = 6
)

# Markers
DefaultAssay(seurat_fib) <- "RNA"
fib_markers <- FindAllMarkers(seurat_fib, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.25)
write.csv(fib_markers, file.path(out_dir, "Fibro_markers_res0.2.csv"), row.names = FALSE)

# Export markers to Excel
wb <- createWorkbook()
clusters <- sort(unique(fib_markers$cluster))
for (cl in clusters) {
  df <- fib_markers[fib_markers$cluster == cl, ]
  df <- df[order(df$avg_log2FC, decreasing = TRUE), ]
  addWorksheet(wb, paste0("Cluster_", cl))
  writeData(wb, sheet = paste0("Cluster_", cl), df)
}
saveWorkbook(wb, file.path(out_dir, "Fibro_markers_res0.2_by_cluster.xlsx"), overwrite = TRUE)

saveRDS(seurat_fib, file.path(out_dir, "Fibro_subset_res0.2.rds"))

# myCAF / iCAF FeaturePlots (use default palette; can set fixed if needed)
DefaultAssay(seurat_fib) <- "RNA"

myCAF_genes <- c("ACTA2","TAGLN","MYL9","HOPX","POSTN","TPM1","TPM2","MMP11","VIM","CTGF",
                 "COL1A1","COL5A1","COL6A1")
iCAF_genes  <- c("IL6","CXCL12","PTGS2","CCL2","IL8","DPT","LMNA","AGTR1","HAS1","CXCL1",
                 "CXCL2","PDGFRA","CFD")

p_myCAF <- FeaturePlot(seurat_fib, features = myCAF_genes) + labs(title = "myCAF markers")
ggsave(file.path(out_dir, "Fibro_myCAF_FeaturePlot.pdf"), p_myCAF, width = 10, height = 8, dpi = 300)

p_iCAF <- FeaturePlot(seurat_fib, features = iCAF_genes) + labs(title = "iCAF markers")
ggsave(file.path(out_dir, "Fibro_iCAF_FeaturePlot.pdf"), p_iCAF, width = 10, height = 8, dpi = 300)

message("04 done.")
