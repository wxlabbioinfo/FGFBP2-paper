#!/usr/bin/env Rscript

# ============================================================
# CellChat analysis (Secreted Signaling) for GSE212966
# 1) Run CellChat on annotated integrated object
# 2) Run CellChat with Tumor cells split into EHF+ vs EHF-
# ============================================================

suppressPackageStartupMessages({
  library(Seurat)
  library(CellChat)
  library(dplyr)
  library(ggplot2)
  library(stringr)
  library(future)
})

args <- commandArgs(trailingOnly = TRUE)
get_arg <- function(flag, default = NULL) {
  hit <- which(args == flag)
  if (length(hit) == 0) return(default)
  if (hit == length(args)) stop(paste("Missing value for", flag))
  args[hit + 1]
}
csv_to_vec <- function(x) {
  if (is.null(x) || is.na(x) || x == "") return(character(0))
  trimws(unlist(strsplit(x, ",")))
}

seurat_rds <- get_arg("--seurat_rds", default = NULL)
tumor_rds  <- get_arg("--tumor_rds",  default = "")
out_dir    <- get_arg("--out_dir",    default = "./output_cellchat")
species    <- tolower(get_arg("--species", default = "human"))

ehf_low    <- csv_to_vec(get_arg("--ehf_low",  default = "7"))
ehf_high   <- csv_to_vec(get_arg("--ehf_high", default = "0,1,2,3,4,5,6"))

workers    <- as.integer(get_arg("--workers", default = "4"))
max_mem_gb <- as.numeric(get_arg("--max_mem_gb", default = "4"))

if (is.null(seurat_rds) || !file.exists(seurat_rds)) stop("Cannot find --seurat_rds")
if (tumor_rds != "" && !file.exists(tumor_rds)) stop("Cannot find --tumor_rds")

dir.create(out_dir, showWarnings = FALSE, recursive = TRUE)

message("seurat_rds: ", normalizePath(seurat_rds))
message("tumor_rds : ", ifelse(tumor_rds == "", "(not provided)", normalizePath(tumor_rds)))
message("out_dir   : ", normalizePath(out_dir))
message("species   : ", species)

# ------------------------------------------------------------
# Helper: get counts matrix (Seurat v5 layers-aware)
# ------------------------------------------------------------
get_counts_matrix <- function(obj, assay = "RNA") {
  DefaultAssay(obj) <- assay

  # Prefer standard counts slot if available
  m <- tryCatch(GetAssayData(obj, assay = assay, slot = "counts"), error = function(e) NULL)
  if (!is.null(m) && ncol(m) > 0) {
    return(m)
  }

  # Seurat v5: counts may be split across layers
  assay_obj <- obj[[assay]]
  layer_names <- tryCatch(names(assay_obj@layers), error = function(e) character(0))
  if (length(layer_names) == 0) stop("No layers found and counts slot unavailable.")

  use_ln <- layer_names[grepl("^counts", layer_names)]
  if (length(use_ln) == 0) stop("No 'counts*' layers found in RNA assay.")

  mats <- lapply(use_ln, function(nm) assay_obj@layers[[nm]])
  m_all <- do.call(cbind, mats)

  rownames(m_all) <- rownames(obj[[assay]])
  colnames(m_all) <- colnames(obj)

  m_all
}

# ------------------------------------------------------------
# Helper: build CellChat object (Secreted Signaling)
# ------------------------------------------------------------
run_cellchat_secreted <- function(counts, labels, out_prefix) {
  meta <- data.frame(labels = labels, row.names = names(labels), stringsAsFactors = FALSE)

  common_cells <- intersect(colnames(counts), rownames(meta))
  counts <- counts[, common_cells, drop = FALSE]
  meta   <- meta[common_cells, , drop = FALSE]
  counts <- counts[, rownames(meta), drop = FALSE]
  stopifnot(all(rownames(meta) == colnames(counts)))

  cellchat <- createCellChat(object = counts, meta = meta, group.by = "labels")

  if (species == "human") {
    CellChatDB <- CellChatDB.human
  } else if (species == "mouse") {
    CellChatDB <- CellChatDB.mouse
  } else {
    stop("species must be 'human' or 'mouse'")
  }

  CellChatDB.use <- subsetDB(CellChatDB, search = "Secreted Signaling", key = "annotation")
  cellchat@DB <- CellChatDB.use

  cellchat <- subsetData(cellchat)

  options(future.globals.maxSize = max_mem_gb * 1e9)
  plan("multisession", workers = workers)

  cellchat <- identifyOverExpressedGenes(cellchat)
  cellchat <- identifyOverExpressedInteractions(cellchat)
  cellchat <- computeCommunProb(cellchat, type = "triMean")
  cellchat <- filterCommunication(cellchat, min.cells = 10)
  cellchat <- computeCommunProbPathway(cellchat)
  cellchat <- aggregateNet(cellchat)

  saveRDS(cellchat, file = file.path(out_dir, paste0(out_prefix, "_cellchat.rds")))

  df.net <- subsetCommunication(cellchat)
  write.csv(df.net, file = file.path(out_dir, paste0(out_prefix, "_communication_network.csv")), row.names = FALSE)

  # Basic circle plots
  groupSize <- as.numeric(table(cellchat@idents))

  pdf(file.path(out_dir, paste0(out_prefix, "_circle_count.pdf")), width = 10, height = 8)
  netVisual_circle(cellchat@net$count, vertex.weight = groupSize, weight.scale = TRUE,
                   label.edge = FALSE, title.name = "Number of interactions")
  dev.off()

  pdf(file.path(out_dir, paste0(out_prefix, "_circle_weight.pdf")), width = 10, height = 8)
  netVisual_circle(cellchat@net$weight, vertex.weight = groupSize, weight.scale = TRUE,
                   label.edge = FALSE, title.name = "Interaction weights/strength")
  dev.off()

  pdf(file.path(out_dir, paste0(out_prefix, "_heatmap_weight.pdf")), width = 12, height = 10)
  netVisual_heatmap(cellchat, measure = "weight")
  dev.off()

  cellchat
}

# ------------------------------------------------------------
# 1) Global CellChat (based on current identities)
# ------------------------------------------------------------
seurat_integrated <- readRDS(seurat_rds)

counts_all  <- get_counts_matrix(seurat_integrated, assay = "RNA")
labels_all  <- Idents(seurat_integrated)

cellchat_all <- run_cellchat_secreted(
  counts = counts_all,
  labels = labels_all,
  out_prefix = "global"
)

# ------------------------------------------------------------
# 2) Optional: split Tumor cells into EHF+ vs EHF-
# ------------------------------------------------------------
if (tumor_rds != "") {
  seurat_tumor <- readRDS(tumor_rds)

  # Define EHF groups inside tumor object (cluster-based)
  if (!("seurat_clusters" %in% colnames(seurat_tumor@meta.data))) {
    stop("seurat_tumor must contain seurat_clusters in meta.data")
  }

  seurat_tumor$EHF_group <- ifelse(
    as.character(seurat_tumor$seurat_clusters) %in% ehf_low,
    "EHF_minus_Tumor",
    "EHF_plus_Tumor"
  )

  # Create a new label vector for integrated object:
  # - non-tumor cells keep original identity
  # - tumor cells are replaced with EHF_plus/minus labels
  labels2 <- as.character(Idents(seurat_integrated))
  names(labels2) <- colnames(seurat_integrated)

  tumor_cells <- intersect(colnames(seurat_integrated), colnames(seurat_tumor))
  labels2[tumor_cells] <- seurat_tumor$EHF_group[match(tumor_cells, colnames(seurat_tumor))]
  labels2 <- factor(labels2)

  counts2 <- counts_all  # already aligned to seurat_integrated cells

  cellchat_ehf <- run_cellchat_secreted(
    counts = counts2,
    labels = labels2,
    out_prefix = "with_EHFsplit"
  )

  # Bubble plots for EHF+/- as sources
  pdf(file.path(out_dir, "with_EHFsplit_bubble_EHFplus_minus_sources.pdf"), width = 12, height = 20)
  netVisual_bubble(cellchat_ehf,
                   sources.use = c("EHF_plus_Tumor", "EHF_minus_Tumor"),
                   targets.use = unique(cellchat_ehf@meta$labels),
                   remove.isolate = FALSE)
  dev.off()

  pdf(file.path(out_dir, "with_EHFsplit_bubble_EHFplus_sources.pdf"), width = 12, height = 20)
  netVisual_bubble(cellchat_ehf,
                   sources.use = c("EHF_plus_Tumor"),
                   targets.use = unique(cellchat_ehf@meta$labels),
                   remove.isolate = FALSE)
  dev.off()

  pdf(file.path(out_dir, "with_EHFsplit_bubble_EHFminus_sources.pdf"), width = 12, height = 20)
  netVisual_bubble(cellchat_ehf,
                   sources.use = c("EHF_minus_Tumor"),
                   targets.use = unique(cellchat_ehf@meta$labels),
                   remove.isolate = FALSE)
  dev.off()

  # Example pathway analysis (PDGF)
  pathways.show <- c("PDGF")
  pdf(file.path(out_dir, "with_EHFsplit_PDGF_aggregate_circle.pdf"), width = 10, height = 8)
  netVisual_aggregate(cellchat_ehf, signaling = pathways.show, layout = "circle")
  dev.off()

  pdf(file.path(out_dir, "with_EHFsplit_PDGF_heatmap.pdf"), width = 12, height = 10)
  netVisual_heatmap(cellchat_ehf, signaling = pathways.show, color.heatmap = "Reds")
  dev.off()

  # One ligand-receptor pair example within PDGF
  pairLR <- extractEnrichedLR(cellchat_ehf, signaling = pathways.show, geneLR.return = FALSE)
  if (nrow(pairLR) >= 4) {
    LR.show <- pairLR[4, , drop = FALSE]
    vertex.receiver <- seq(1, min(4, length(levels(cellchat_ehf@idents))))

    pdf(file.path(out_dir, "with_EHFsplit_PDGF_oneLR_hierarchy.pdf"), width = 12, height = 10)
    netVisual_individual(cellchat_ehf,
                         signaling = pathways.show,
                         pairLR.use = LR.show,
                         vertex.receiver = vertex.receiver,
                         arrow.size = 1.5,
                         vertex.label.cex = 1.4,
                         edge.width.max = 15)
    dev.off()
  }
}

message("CellChat pipeline completed. Outputs saved in: ", normalizePath(out_dir))
